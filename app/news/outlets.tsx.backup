import React, { useEffect, useState, useCallback } from 'react';
import { View, Text, StyleSheet, FlatList, TextInput, TouchableOpacity, ScrollView, Image, ActivityIndicator, RefreshControl, Dimensions } from 'react-native';
import { useSafeAreaInsets } from 'react-native-safe-area-context';
import { useRouter } from 'expo-router'
import { debouncedRouter } from '@/utils/navigationDebounce';;
import { Search, TrendingUp, Clock, Bookmark, ChevronRight, Calendar, ArrowLeft } from 'lucide-react-native';
import { useAuth } from '@/hooks/useAuth';
import { supabase, type TrendingArticle } from '@/lib/supabase';
import CachedImage from '@/components/CachedImage';

const { width } = Dimensions.get('window');

function flagEmoji(cc: string): string {
  if (!cc || cc.length !== 2) return 'ðŸ³ï¸';
  const codePoints = cc.toUpperCase().split('').map(c => 127397 + c.charCodeAt(0));
  return String.fromCodePoint(...codePoints);
}

export default function NewsOutletsDirectory() {
  const router = useRouter();
  const { user, profile } = useAuth();
  const [query, setQuery] = useState('');
  const insets = useSafeAreaInsets();
  const listRef = useRef<SectionList<NewsOutlet>>(null);

  const [favorites, setFavorites] = useState<Set<string>>(new Set());
  const [expanded, setExpanded] = useState<Record<string, boolean>>({});
  const [dbOutlets, setDbOutlets] = useState<Array<{ country_code: string; outlet: NewsOutlet }>>([]);

  useEffect(() => {
    const loadFavorites = async () => {
      try {
        const raw = await AsyncStorage.getItem('favoriteCountries');
        if (raw) {
          const arr: string[] = JSON.parse(raw);
          const favSet = new Set(arr);
          setFavorites(favSet);
          setExpanded((prev) => {
            const next = { ...prev } as Record<string, boolean>;
            arr.forEach((cc) => { next[cc] = true; });
            return next;
          });
        }
      } catch {}
    };
    loadFavorites();
  }, []);

  // Refresh database outlets whenever screen comes into focus
  useFocusEffect(
    React.useCallback(() => {
      fetchDbOutlets();
    }, [])
  );

  const fetchDbOutlets = async () => {
    try {
      const { data, error } = await supabase
        .from('news_outlets')
        .select('id, country_code, name, url, logo')
        .order('country_code');
      if (error) throw error;
      if (data && data.length > 0) {
        const mapped = data.map((d: any) => ({
          country_code: d.country_code,
          outlet: {
            id: d.id,
            name: d.name,
            url: d.url,
            logo: d.logo || undefined,
          } as NewsOutlet,
        }));
        setDbOutlets(mapped);
      }
    } catch (e) {
      console.log('fetchDbOutlets error', e);
    }
  };

  const saveFavorites = async (fav: Set<string>) => {
    try {
      await AsyncStorage.setItem('favoriteCountries', JSON.stringify(Array.from(fav)));
    } catch {}
  };

  const toggleFavorite = (countryCode: string) => {
    setFavorites((prev) => {
      const next = new Set(prev);
      if (next.has(countryCode)) next.delete(countryCode); else next.add(countryCode);
      saveFavorites(next);
      return next;
    });
  };

  const toggleExpanded = (countryCode: string) => {
    setExpanded((prev) => ({ ...prev, [countryCode]: !prev[countryCode] }));
  };

  const sections = useMemo(() => {
    const q = query.trim().toLowerCase();
    
    // Build a merged map of countries with outlets from both curated constants and database
    const countryMap: Record<string, { countryName: string; outlets: NewsOutlet[] }> = {};
    
    // Add curated outlets
    COUNTRY_OUTLETS.forEach((c) => {
      if (!countryMap[c.countryCode]) {
        countryMap[c.countryCode] = { countryName: c.countryName, outlets: [] };
      }
      countryMap[c.countryCode].outlets.push(...c.outlets);
    });
    
    // Add database outlets
    dbOutlets.forEach((item) => {
      const cc = item.country_code.toLowerCase();
      if (!countryMap[cc]) {
        // Country not in curated list; create entry with country code as name
        countryMap[cc] = { countryName: cc.toUpperCase(), outlets: [] };
      }
      // Check for duplicates by name and URL to avoid showing the same outlet twice
      const exists = countryMap[cc].outlets.some(
        (existing) => existing.name === item.outlet.name && existing.url === item.outlet.url
      );
      if (!exists) {
        countryMap[cc].outlets.push(item.outlet);
      }
    });
    
    // Convert map to array and filter by search query
    let base = Object.entries(countryMap).map(([code, info]) => {
      const filtered = q
        ? info.outlets.filter(
            (o) => o.name.toLowerCase().includes(q) || o.url.toLowerCase().includes(q)
          )
        : info.outlets;
      return { countryCode: code, countryName: info.countryName, outlets: filtered };
    }).filter((c) => c.outlets.length > 0);

    base.sort((a, b) => {
      const af = favorites.has(a.countryCode) ? 0 : 1;
      const bf = favorites.has(b.countryCode) ? 0 : 1;
      if (af !== bf) return af - bf;
      return a.countryName.localeCompare(b.countryName);
    });

    const effectiveExpanded: Record<string, boolean> = { ...expanded };
    if (q) {
      base.forEach((c) => { effectiveExpanded[c.countryCode] = true; });
    }

    const mapped = base.map((c) => ({
      title: `${flagEmoji(c.countryCode)} ${c.countryName}`,
      countryCode: c.countryCode,
      data: effectiveExpanded[c.countryCode] ? c.outlets : [],
      count: c.outlets.length,
    }));
    return mapped;
  }, [query, favorites, expanded, dbOutlets]);

  const scrollToCountry = (cc: string) => {
    const idx = sections.findIndex((s: any) => s.countryCode === cc);
    if (idx >= 0 && listRef.current) {
      setExpanded((prev) => ({ ...prev, [cc]: true }));
      setTimeout(() => {
        listRef.current?.scrollToLocation({ sectionIndex: idx, itemIndex: 0, animated: true, viewOffset: 8 });
      }, 50);
    }
  };

  return (
    <View style={styles.container}>
      <SectionList
        ref={listRef}
        sections={sections as any}
        keyExtractor={(item: NewsOutlet) => item.id}
        renderItem={({ item }) => <OutletCard outlet={item} />}
        ListHeaderComponent={
          <View style={[styles.header, { paddingTop: Math.max(insets.top + 8, 12) }]}> 
            <View style={styles.headerRow}>
              <View>
                <Text style={styles.title}>News Outlets Directory</Text>
                <Text style={styles.subtitle}>Tap a publisher to open their official site</Text>
              </View>
              {(profile?.is_admin || profile?.role === 'admin') && (
                <TouchableOpacity
                  onPress={() => debouncedRouter.push('/news/admin')}
                  style={styles.addButton}
                  accessibilityLabel="Add news outlet"
                >
                  <Plus size={22} color="#FFFFFF" />
                </TouchableOpacity>
              )}
            </View>
            <TextInput
              value={query}
              onChangeText={setQuery}
              placeholder="Search outlets or URLs"
              placeholderTextColor="#8E8E93"
              style={styles.search}
              returnKeyType="search"
            />
            {favorites.size > 0 && (
              <View style={styles.favRow}>
                <Text style={styles.favLabel}>Favorite countries</Text>
                <ScrollView horizontal showsHorizontalScrollIndicator={false} contentContainerStyle={styles.favChips}>
                  {Array.from(favorites).map((cc) => {
                    const info = COUNTRY_OUTLETS.find((c) => c.countryCode === cc);
                    if (!info) return null;
                    return (
                      <TouchableOpacity key={cc} style={styles.chip} onPress={() => scrollToCountry(cc)}>
                        <Text style={styles.chipText}>{`${flagEmoji(cc)} ${info.countryName}`}</Text>
                      </TouchableOpacity>
                    );
                  })}
                </ScrollView>
              </View>
            )}
          </View>
        }
        renderSectionHeader={({ section }) => {
          const isFav = favorites.has(section.countryCode as string);
          const isOpen = (expanded as any)[section.countryCode];
          return (
            <View>
              <TouchableOpacity
                accessibilityRole="button"
                onPress={() => toggleExpanded(section.countryCode as string)}
                style={styles.sectionHeaderRow}
              >
                {isOpen ? <ChevronDown size={18} color="#1C1C1E" /> : <ChevronRight size={18} color="#1C1C1E" />}
                <Text style={styles.sectionHeader}>{section.title}</Text>
                <Text style={styles.sectionCount}>({section.count})</Text>
                <TouchableOpacity
                  onPress={(e) => { e.stopPropagation?.(); toggleFavorite(section.countryCode as string); }}
                  style={styles.favButton}
                  accessibilityLabel={isFav ? 'Unfavorite country' : 'Favorite country'}
                >
                  <Star size={18} color={isFav ? '#FFD700' : '#C7C7CC'} fill={isFav ? '#FFD700' : 'transparent'} />
                </TouchableOpacity>
              </TouchableOpacity>
            </View>
          );
        }}
        contentContainerStyle={styles.listContent}
        stickySectionHeadersEnabled={false}
      />
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#F8F9FB',
  },
  header: {
    paddingTop: 12,
    paddingHorizontal: 16,
    paddingBottom: 8,
    backgroundColor: '#F8F9FB',
  },
  headerRow: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    marginBottom: 8,
  },
  title: {
    fontSize: 22,
    fontWeight: '800',
    color: '#000',
  },
  subtitle: {
    fontSize: 13,
    color: '#636366',
    marginTop: 2,
    marginBottom: 10,
  },
  search: {
    backgroundColor: '#FFFFFF',
    borderRadius: 10,
    paddingHorizontal: 12,
    paddingVertical: 10,
    borderWidth: 1,
    borderColor: '#E5E5EA',
  },
  addButton: {
    backgroundColor: '#007AFF',
    borderRadius: 20,
    padding: 8,
  },
  listContent: {
    paddingHorizontal: 16,
    paddingTop: 10,
    paddingBottom: 24,
  },
  sectionHeaderRow: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
    paddingVertical: 6,
  },
  sectionHeader: {
    fontSize: 16,
    fontWeight: '700',
    color: '#1C1C1E',
  },
  sectionCount: {
    marginLeft: 6,
    color: '#8E8E93',
    fontWeight: '600',
  },
  favButton: {
    marginLeft: 'auto',
    padding: 6,
  },
  favRow: {
    marginTop: 10,
  },
  favLabel: {
    color: '#636366',
    fontSize: 12,
    marginBottom: 6,
  },
  favChips: {
    gap: 8,
    paddingRight: 6,
  },
  chip: {
    backgroundColor: '#FFFFFF',
    borderWidth: 1,
    borderColor: '#E5E5EA',
    borderRadius: 16,
    paddingHorizontal: 10,
    paddingVertical: 6,
  },
  chipText: {
    color: '#1C1C1E',
    fontWeight: '600',
  },
});
